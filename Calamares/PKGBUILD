# Ezarcher Calamares Installer pkgbuild

pkgname=calamares
pkgver=3.3.14
_pkgver=3.3.14
pkgrel=5
pkgdesc='Distribution-independent installer framework'
arch=('x86_64')
license=(GPL)
url="https://codeberg.org/Calamares/calamares/releases"
license=('LGPL')
install=install.install
depends=(
  'boost-libs'
  'ckbcomp'
  'cryptsetup'
  'doxygen'
  'efibootmgr'
  'gptfdisk'
  'gtk-update-icon-cache'
  'icu'
  'kconfig'
  'kcoreaddons'
  'kcrash'
  'ki18n'
  'kparts'
  'kpmcore'
  'kservice'
  'kwidgetsaddons'
  'libpwquality'
  'mkinitcpio-openswap'
  'polkit-qt6'
  'rsync'
  'qt6-declarative'
  'solid'
  'squashfs-tools'
  'yaml-cpp'
)
makedepends=(
  'boost'
  'cmake'
  'extra-cmake-modules'
  'git'
  'fakeroot'
  'ninja'
  'python-jsonschema'
  'python-pyaml'
  'python-unidecode'
  'qt6-tools'
)

source=("$pkgname-$pkgver.tar.gz::https://codeberg.org/Calamares/calamares/releases/download/v$pkgver/calamares-$pkgver.tar.gz"
        "cal-araf.desktop"
        "calamares_polkit"
        "calamares-wrapper")

sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

prepare() {
  cp -rv ../modules/* "$srcdir/calamares-${pkgver}/src/modules/"

  sed -i -e 's/"Install configuration files" OFF/"Install configuration files" ON/' "$srcdir/calamares-${pkgver}/CMakeLists.txt"
  sed -i -e "s/desired_size = 512 \* 1024 \* 1024  \# 512MiB/desired_size = 512 \* 1024 \* 1024 \* 16  \# 8589MiB/" "$srcdir/calamares-${pkgver}/src/modules/fstab/main.py"
}

build() {
	cd ${srcdir}/calamares-${pkgver}

	mkdir -p build
	cd build
        cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_INSTALL_PREFIX=/usr \
              -DCMAKE_INSTALL_LIBDIR=/usr/lib \
              -DINSTALL_CONFIG=OFF \
              -DWITH_QT6=ON \
              -DWITH_PYBIND11=ON \
              -DSKIP_MODULES="tracking webview interactiveterminal initramfs netinstall \
                              initramfscfg dracut dracutlukscfg finishedq summaryq \
                              dummyprocess dummypython dummycpp usersq oemid packagechooser \
                              dummypythonqt services-openrc keyboardq zfs zfshostid \
                              localeq plasmalnf welcomeq notesqml packagechooserq"
        make
}

package() {
  cd ${srcdir}/calamares-${pkgver}/build
  make DESTDIR="$pkgdir" install

  install -Dm644 "$srcdir/cal-araf.desktop" "$pkgdir/usr/share/applications/cal-araf.desktop"
  install -Dm755 "$srcdir/cal-araf.desktop" "$pkgdir/home/liveuser/Desktop/cal-araf.desktop"
  chmod +x "$pkgdir/home/liveuser/Desktop/cal-araf.desktop"

  install -Dm644 "$srcdir/calamares-wrapper" "$pkgdir/usr/local/bin/calamares-wrapper"
  chmod +x "$pkgdir/usr/local/bin/calamares-wrapper"
  install -Dm755 "$srcdir/calamares_polkit" "$pkgdir/usr/bin/calamares_polkit"
  rm "$pkgdir/usr/share/applications/calamares.desktop"
}
